# SPDX-License-Identifier: LGPL-3.0-or-later
# Copyright (C) 2020 Daniel Thompson

import wasp
import icons
import fonts

# 2-bit RLE, generated from ./media/green.png, 232 bytes
green = (
    b'\x02'
    b'\xf0\xf0'
    b'@\xde\x7f\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff'
    b'\xff\xff\xff\xff\xa2'
)

# 2-bit RLE, generated from ./media/voltorb.png, 1309 bytes
voltorb = (
    b'\x02'
    b'\x8a\x96'
    b'@\xde\x7f0\x80\xff\x83\x7fH\x83\x7fH\x83\x7f<\x83'
    b'F\x86\x7f<\x83F\x86\x7f<\x83F\x86\x7f9\x92O'
    b"\x83\x7f'\x92O\x83\x7f'\x92O\x83|\xc0\x06\xdeR"
    b'\x8fF\x86\x7f\x00\xdeR\x8fF\x86\x7f\x00\xdeR\x8fF'
    b'\x86v\xcc\x98\xccO\x95v\xcc\x98\xccO\x95v\xcc\x98'
    b'\xccO\x95p\xc9\xaa\xc9I\x83C\x8cs\xc9\xaa\xc9I'
    b'\x83C\x8cs\xc9\xaa\xc9I\x83C\x8cm\xc9\xb6\xc9L'
    b'\x89m\xc9\xb6\xc9L\x89m\xc9\xb6\xc9L\x89j\xc6\xbf'
    b'\x03\xc6L\x89g\xc6\xbf\x03\xc6L\x89g\xc6\xbf\x03\xc6'
    b'L\x89d\xc6\xbf\t\xc6L\x8f[\xc6\xbf\t\xc6L\x8f'
    b'[\xc6\xbf\t\xc6L\x8fX\xc6\xbf\x0f\xc6F\x8f[\xc6'
    b'\xbf\x0f\xc6F\x8f[\xc6\xbf\x0f\xc6F\x8fX\xc6\xbf\x15'
    b'\xc6I\x86[\xc6\xbf\x15\xc6I\x86[\xc6\xbf\x15\xc6I'
    b'\x86X\xc6\xbf\x1b\xc6F\x86X\xc6\xbf\x1b\xc6F\x86X'
    b'\xc6\xbf\x1b\xc6F\x86X\xc3\xbf!\xc3I\x86U\xc3\xbf'
    b'!\xc3I\x86U\xc3\xbf!\xc3I\x86R\xc6\xbf!\xc6'
    b'F\x83U\xc6\xbf!\xc6F\x83U\xc6\xbf!\xc6F\x83'
    b'U\xc3\x89\xc6\xbf\t\xc6\x89\xc3^\xc3\x89\xc6\xbf\t\xc6'
    b'\x89\xc3^\xc3\x89\xc6\xbf\t\xc6\x89\xc3[\xc6\x8f\xc6\xbc'
    b'\xc6\x8f\xc6X\xc6\x8f\xc6\xbc\xc6\x8f\xc6X\xc6\x8f\xc6\xbc'
    b'\xc6\x8f\xc6X\xc3\x8fI\xc3\xb6\xc3I\x8f\xc3X\xc3\x8f'
    b'I\xc3\xb6\xc3I\x8f\xc3X\xc3\x8fI\xc3\xb6\xc3I\x8f'
    b'\xc3X\xc3\x8fL\xc6\xaa\xc6L\x8f\xc3X\xc3\x8fL\xc6'
    b'\xaa\xc6L\x8f\xc3X\xc3\x8fL\xc6\xaa\xc6L\x8f\xc3U'
    b'\xc6\x8fR\xc6\x86\xc3\x8c\xc3\x86\xc6R\x8f\xc6R\xc6\x8f'
    b'R\xc6\x86\xc3\x8c\xc3\x86\xc6R\x8f\xc6R\xc6\x8fR\xc6'
    b'\x86\xc3\x8c\xc3\x86\xc6R\x8f\xc6R\xc3\x92U\xc6\x83\xc3'
    b'\x8c\xc3\x83\xc6U\x92\xc3R\xc3\x92U\xc6\x83\xc3\x8c\xc3'
    b'\x83\xc6U\x92\xc3R\xc3\x92U\xc6\x83\xc3\x8c\xc3\x83\xc6'
    b'U\x92\xc3R\xc3\x92U\xc3C\xc6\x8c\xc6C\xc3U\x92'
    b'\xc3R\xc3\x92U\xc3C\xc6\x8c\xc6C\xc3U\x92\xc3R'
    b'\xc3\x92U\xc3C\xc6\x8c\xc6C\xc3U\x92\xc3R\xc3\x95'
    b'X\x98X\x95\xc3R\xc3\x95X\x98X\x95\xc3R\xc3\x95'
    b'X\x98X\x95\xc3R\xc3\xbf3\xc3R\xc3\xbf3\xc3R'
    b'\xc3\xbf3\xc3R\xc3@1\x7f3\xc3\x80\xde\x92\xc3\x7f'
    b'3\xc3\x92\xc3\x7f3\xc3\x92\xc3\xbf3\xc3\x92\xc3\xbf3'
    b'\xc3\x92\xc3\xbf3\xc3\x92\xc3\xbf3\xc3\x92\xc3\xbf3\xc3'
    b'\x92\xc3\xbf3\xc3\x92\xc3\xbf3\xc3\x92\xc3\xbf3\xc3\x92'
    b'\xc3\xbf3\xc3\x92\xc3C\xbf-C\xc3\x92\xc3C\xbf-'
    b'C\xc3\x92\xc3C\xbf-C\xc3\x92\xc3C\xbf-C\xc3'
    b'\x92\xc3C\xbf-C\xc3\x92\xc3C\xbf-C\xc3\x92\xc3'
    b'C\xbf-C\xc3\x92\xc3C\xbf-C\xc3\x92\xc3C\xbf'
    b"-C\xc3\x92\xc3F\xbf'F\xc3\x92\xc3F\xbf'F"
    b"\xc3\x92\xc3F\xbf'F\xc3\x92\xc6C\xbf'C\xc6\x92"
    b"\xc6C\xbf'C\xc6\x92\xc6C\xbf'C\xc6\x95\xc3F"
    b'\xbf!F\xc3\x98\xc3F\xbf!F\xc3\x98\xc3F\xbf!'
    b'F\xc3\x98\xc3F\xbf!F\xc3\x98\xc3F\xbf!F\xc3'
    b'\x98\xc3F\xbf!F\xc3\x98\xc6F\xbf\x1bF\xc6\x98\xc6'
    b'F\xbf\x1bF\xc6\x98\xc6F\xbf\x1bF\xc6\x9b\xc3I\xbf'
    b'\x15I\xc3\x9e\xc3I\xbf\x15I\xc3\x9e\xc3I\xbf\x15I'
    b'\xc3\x95\xc0\xff\xc3\x86@\x06F\x801\x89\xc0\xde\xff\x0f'
    b'\x89F\xd5@\xffC\xc6\x80\x06\x86\xc01\xc9@\xde\x7f'
    b'\x0f\xc9\x86U\x80\xff\x83F\xc0\x06\xc6@1I\x80\xde'
    b'\xbf\x0fI\xc6\x92\xc0\xff\xc6\x89@\x06C\x801\x83\xc3'
    b'\x86\xc0\xde\xff\t\x86@\xffC\x83\x80\x06\x83\xd5F\xc9'
    b'\x83\xc01\xc3C\xc6@\xde\x7f\t\xc6\x80\xff\x83\xc3\xc0'
    b'\x06\xc3U\x86I\xc3@1C\x83F\x80\xde\xbf\tF'
    b'\xc0\xff\xc3C@\x06C\x98\xc6\x86F\xc6\x801\x86\xc0'
    b'\xde\xff\x03\x86@\xffF\x80\x06\x86\xd8F\xc6\x86F\xc0'
    b'1\xc6@\xde\x7f\x03\xc6\x80\xff\x86\xc0\x06\xc6X\x86F'
    b'\xc6\x86@1F\x80\xde\xbf\x03F\xc0\xff\xc6@\x06F'
    b'\x98\xc6\x89F\xc6\x801\x89\xc0\xde\xf6\x89@\xffF\x80'
    b'\x06\x86\xdbF\xc9\x86F\xc01\xc9@\xdev\xc9\x80\xff'
    b'\x86\xc0\x06\xc6[\x86I\xc6\x86@1I\x80\xde\xb6I'
    b'\xc0\xff\xc6@\x06F\x98\xcf\x86F\xc9\x801\x89\xc0\xde'
    b'\xea\x89@\xffI\x80\x06\x86\xdbO\xc6\x86I\xc01\xc9'
    b'@\xdej\xc9\x80\xff\x89\xc0\x06\xc6[\x8fF\xc6\x89@'
    b'1I\x80\xde\xaaI\xc0\xff\xc9@\x06F\x98\xcf\x8cF'
    b'\xcc\x801\x8c\xc0\xde\xd8\x8c@\xffL\x80\x06\x86\xdbO'
    b'\xcc\x86L\xc01\xcc@\xdeX\xcc\x80\xff\x8c\xc0\x06\xc6'
    b'[\x8fL\xc6\x8c@1L\x80\xde\x98L\xc0\xff\xcc@'
    b'\x06F\xa4\xc9\x8cF\xd2\x801\x9e\xd2F\xc0\xde\xe7@'
    b'\xffI\xcc\x80\x06\x86R\xc01\xdeR\x86@\xdeg\x80'
    b'\xff\x89L\xc0\x06\xc6\x92@1^\x92\xc6\x80\xde\xaa\xc0'
    b'\xff\xc9\x8c@\x06I\xf6I\xad\xc9\x8cI\xf6I\xad\xc9'
    b'\x8cI\xf6I\xad\xcc\x83\xc3\x89I\xeaI\xb3\xcc\x83\xc3'
    b'\x89I\xeaI\xb3\xcc\x83\xc3\x89I\xeaI\xb0\xd5\x8fL'
    b'\xd8L\xb6\xd5\x8fL\xd8L\xb6\xd5\x8fL\xd8L\xb6\xc6'
    b'\x86\xcf\x92^\xbf\x00\xc6\x86\xcf\x92^\xbf\x00\xc6\x86\xcf'
    b"\x92^\xbc\xc3\x8f\xd2\xbf'\xc3\x8f\xd2\xbf'\xc3\x8f\xd2"
    b'\xbf9\xc6\x86\xc3\xbf<\xc6\x86\xc3\xbf<\xc6\x86\xc3\xbf'
    b'<\xc3\xbfH\xc3\xbfH\xc3\xbf0'
)

class StopwatchApp():
    """Stopwatch application.

    .. figure:: res/TimerApp.png
        :width: 179

        Screenshot of the stopwatch application
    """
    NAME = 'Timer'
    ICON = icons.app

    def __init__(self):
        self._reset()
        self._count = 0

    def foreground(self):
        """Activate the application."""
        wasp.system.bar.clock = False
        self._draw()
        wasp.system.request_tick(97)
        wasp.system.request_event(wasp.EventMask.TOUCH |
                                  wasp.EventMask.BUTTON |
                                  wasp.EventMask.NEXT)

    def sleep(self):
        return True

    def wake(self):
        self._update()

    def swipe(self, event):
        """Handle NEXT events by augmenting the default processing by resetting
        the count if we are not currently timing something.

        No other swipe event is possible for this application.
        """
        if not self._started_at:
            self._reset()
        return True     # Request system default handling

    def press(self, button, state):
        if not state:
            return

        if self._started_at:
            self._update()
            self._started_at = 0
        else:
            uptime = wasp.watch.rtc.get_uptime_ms()
            uptime //= 10
            self._started_at = uptime - self._count
            self._update()

    # def touch(self, event):
        # if self._started_at:
        #     self._update()
        #     self._splits.insert(0, self._count)
        #     del self._splits[4:]
        #     self._nsplits += 1
        # else:
        #     self._reset()
        #     self._update()

        # self._draw_splits()

    def tick(self, ticks):
        self._update()

    def _reset(self):
        self._started_at = 0
        self._count = 0
        self._last_count = -1
        self._splits = []
        self._nsplits = 0

    def _draw_splits(self):
        draw = wasp.watch.drawable
        splits = self._splits
        if 0 == len(splits):
            draw.fill(0, 0, 120, 240, 120)
            return
        y = 240 - 6 - (len(splits) * 24)
        
        n = self._nsplits
        for i, s in enumerate(splits):
            centisecs = s
            secs = centisecs // 100
            centisecs %= 100
            minutes = secs // 60
            secs %= 60

            t = '# {}   {:02}:{:02}.{:02}'.format(n, minutes, secs, centisecs)
            n -= 1

            draw.set_font(fonts.sans24)
            draw.set_color(0xe73c)
            w = fonts.width(fonts.sans24, t)
            draw.string(t, 0, y + (i*24), 240)

    def _draw(self):
        """Draw the display from scratch."""
        draw = wasp.watch.drawable
        draw.set_color(0x3AC7, 0x6D4D) # dark and light green
        # draw.fill()
        draw.blit(green, x = 0, y = 0)
        draw.blit(voltorb, x = 120 - 69, y = 60)
        self._last_count = -1
        self._update()
        # wasp.system.bar.draw()
        # self._draw_splits()

    def _update(self):
        # Before we do anything else let's make sure _count is
        # up to date
        if self._started_at:
            uptime = wasp.watch.rtc.get_uptime_ms()
            uptime //= 10
            self._count = uptime - self._started_at
            if self._count > 999*60*100:
                self._reset()

        # Update the statusbar
        # wasp.system.bar.update()

        if self._last_count != self._count:
            centisecs = self._count
            secs = centisecs // 100
            centisecs %= 100
            minutes = secs // 60
            secs %= 60

            t1 = '{}:{:02}'.format(minutes, secs)
            t2 = '{:02}'.format(centisecs)

            draw = wasp.watch.drawable
            draw.set_font(fonts.sans36)
            draw.set_color(0x3AC7, 0x6D4D) # dark and light green
            w = fonts.width(fonts.sans36, t1)
            draw.string(t1, 180-w, 10)
            # draw.fill(0, 0, 120-36, 180-w, 36)
            draw.set_color(0x3AC7, 0x6D4D) # dark and light green
            draw.set_font(fonts.sans24)
            draw.string(t2, 180, 10+18, width=46)
            self._last_count = self._count
